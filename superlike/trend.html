<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Superlike 数据趋势对比</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .chart-container {
            position: relative;
            margin: auto;
            height: 65vh;
            width: 100%;
        }
    </style>
</head>

<body class="bg-slate-50 p-4 md:p-8">
    <div class="max-w-6xl mx-auto bg-white rounded-2xl shadow-xl p-6 border border-slate-100">
        <div class="flex flex-col md:flex-row md:items-center justify-between mb-8 gap-4 border-b pb-6">
            <div>
                <h1 class="text-2xl font-bold text-slate-800">Superlike 趋势对比分析</h1>
                <p class="text-slate-500 mt-1">支持多日重叠对比。未来时间点不进行数据补全。</p>
            </div>
            <div class="flex flex-wrap gap-3 items-center">
                <div id="selectorsContainer" class="flex flex-wrap gap-3"></div>
                <button id="addSelectorBtn"
                    class="px-3 py-2 bg-indigo-500 hover:bg-indigo-600 text-white text-sm rounded-lg transition-colors flex items-center gap-1">
                    <span class="text-lg leading-none">+</span>
                    <span>添加对比</span>
                </button>
            </div>
        </div>

        <div class="chart-container">
            <canvas id="superlikeChart"></canvas>
        </div>

        <div class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-slate-600">
            <div class="flex items-center gap-2">
                <div class="px-2 py-1 bg-slate-100 rounded italic">注：</div>
                <span>实线点为原始数据或历史插值，曲线截止至当前实际时间。</span>
            </div>
        </div>
    </div>

    <script>
        // 时间点配置
        const TIME_POINTS = [
            "08:40", "09:00", "09:20", "09:40", "10:00", "10:20", "10:40",
            "11:00", "11:20", "11:40", "12:00", "12:20", "12:40",
            "13:00", "13:20", "13:40", "14:00", "14:20", "14:40",
            "15:00", "15:20", "15:40", "16:00", "16:20", "16:40",
            "17:00", "17:20", "17:40", "18:00", "18:20", "18:40",
            "19:00", "19:20", "19:40", "20:00", "20:20", "20:40",
            "21:00", "21:20", "21:40", "22:00", "22:20", "22:40",
            "23:00", "23:20", "23:40", "00:00"
        ];

        // 模拟数据 (直接对应时间点，方便维护)
        const csvData = {
            "2026-02-13  ": {
                "09:40": 3711,
                "10:00": 3740,"10:20": 3842, "10:40": 3881,
                "11:00": 3936, "11:20": null, "11:40": null,
                "12:00": null, "12:20": null, "12:40": null,
                "13:00": null, "13:20": null, "13:40": 4124,
                "14:00": null, "14:20": null, "14:40": 4190,
                "15:00": null, "15:20": 4222, "15:40": null,
                "16:00": null, "16:20": null, "16:40": null,
                "17:00": 4290, "17:20": 4305, "17:40": 4325,
                "18:00": null, "18:20": null, "18:40": null,
                "19:00": null, "19:20": null, "19:40": null,
                "20:00": null, "20:20": null, "20:40": null,
                "21:00": null, "21:20": null, "21:40": null,
                "22:00": null, "22:20": null, "22:40": null,
                "23:00": null, "23:20": null, "23:40": null,
                "00:00": null
            },
            "2026-02-12": {
                "10:20": 3660, "10:40": 3793,
                "11:00": 3826, "11:20": 3871, "11:40": null,
                "12:00": 3931, "12:20": 3967, "12:40": null,
                "13:00": null, "13:20": 4034,
                "14:00": null, "14:20": null,
                "15:00": null, "15:40": null,
                "16:00": null, "16:20": null, "16:40": null,
                "17:00": null, "17:20": null, "17:40": null,
                "18:00": null, "18:20": null,
                "19:00": null, "19:20": null, "19:40": null,
                "20:00": null, "20:20": null, "20:40": null,
                "21:00": null, "21:20": null, "21:40": null,
                "22:00": null, "22:20": null, "22:40": null,
                "23:00": null, "23:20": null, "23:40": null,
                "00:00": 4734
            },
            "2026-02-11": {
                "09:20": 3447, "09:40": 3493, "10:00": 3525, "10:20": 3567, "10:40": 3611,
                "11:00": 3635, "11:20": 3659, "11:40": 3685, "12:00": 3717, "12:20": 3731,
                "12:40": 3826, "13:00": 3866, "13:20": 3877, "14:00": 3900, "14:20": 3922,
                "15:00": 3950, "15:40": 3978, "16:00": 3994, "16:20": 4021, "16:40": 4038,
                "17:00": 4052, "17:20": 4059, "17:40": 4077, "18:00": 4104,
                "18:20": 4116,
                "19:00": 4153, "19:20": 4177, "19:40": 4208,
                "20:00": 4234, "20:20": 4259, "20:40": 4277,
                "21:00": 4295, "21:20": 4308, "21:40": 4335,
                "22:00": 4354, "22:20": 4387, "22:40": 4424,
                "23:00": 4460, "23:20": 4496, "23:40": 4535,
                "00:00": 4592
            },
            "2026-02-10": {
                "09:20": 3261, "09:40": 3332, "10:00": 3351, "10:40": 3540,
                "11:00": 3583, "16:00": 3860, "16:20": 3873, "16:40": 3887,
                "17:00": 3900, "17:40": 3927, "18:20": 3963, "18:40": 3982,
                "19:00": 4016, "19:20": 4028, "20:00": 4073, "20:40": 4125,
                "21:00": 4141, "21:20": 4154, "21:40": 4185, "22:00": 4206,
                "22:20": 4239, "23:00": 4308, "23:20": 4329, "23:40": 4372, "00:00": 4432
            },
            "2026-02-09": {
                "14:00": 3700, "14:20": 3730, "14:40": 3760, "15:00": 3780,
                "15:20": 3785, "15:40": 3795, "16:00": 3813, "16:40": 3834,
                "17:00": 3844, "17:20": 3863, "18:00": 3903, "18:20": 3926
            },
            "2026-02-07": {
                "16:40": 3471, "17:00": 3515, "17:20": 3523, "17:40": 3536, "18:00": 3551,
                "21:00": 3755, "21:20": 3786, "21:40": 3810, "22:00": 3835, "22:20": 3873, "22:40": 3925,
                "23:00": 3937, "00:00": 4019
            },
            "2026-02-06": {
                "08:40": 2653, "09:00": 2706, "09:20": 2742, "09:40": 2761, "10:00": 2793, "10:20": 2827, "10:40": 2857,
                "11:00": 2902, "11:20": 2924, "11:40": 3045, "12:00": 3089, "12:20": 3109, "12:40": 3160,
                "13:00": 3177, "13:20": 3220, "13:40": 3249, "14:00": 3271, "14:20": 3289, "14:40": 3303,
                "15:00": 3317, "15:20": 3337, "15:40": 3350, "16:00": 3368, "16:20": 3375, "16:40": 3393,
                "17:00": 3410, "17:20": 3426, "17:40": 3438, "18:00": 3457, "18:20": 3472, "18:40": 3489,
                "19:00": 3503, "19:20": 3514, "20:00": 3554, "20:20": 3563, "20:40": 3597,
                "21:00": 3617, "21:20": 3644, "21:40": 3681, "22:00": 3708, "22:20": 3757, "22:40": 3794,
                "23:00": 3810, "23:20": 3843, "23:40": 3877, "00:00": 3919
            },
            "2026-02-05": {
                "08:40": 2590, "09:00": 2632, "09:20": 2682, "09:40": 2717, "10:00": 2770, "10:20": 2797, "10:40": 2832,
                "11:00": 2885, "11:20": 2910, "11:40": 2949, "12:00": 2977, "12:20": 3009, "12:40": 3096,
                "13:40": 3165, "14:00": 3181, "14:20": 3194, "14:40": 3204,
                "15:00": 3213, "15:20": 3219, "15:40": 3241, "16:00": 3254, "16:20": 3261, "16:40": 3270,
                "17:00": 3282, "17:20": 3297, "17:40": 3312, "18:00": 3334, "18:20": 3348,
                "19:00": 3402, "19:20": 3428, "19:40": 3454, "20:00": 3475, "20:20": 3504, "20:40": 3535,
                "21:00": 3567, "21:20": 3578, "21:40": 3618, "22:00": 3658, "22:20": 3684, "22:40": 3714,
                "23:00": 3742, "23:20": 3779, "23:40": 3800, "00:00": 3841
            }
        };

        // 颜色配置
        const COLORS = [
            { border: '#4f46e5', bg: '#4f46e5' },  // Indigo
            { border: '#10b981', bg: '#10b981' },  // Emerald
            { border: '#f59e0b', bg: '#f59e0b' },  // Amber
            { border: '#f43f5e', bg: '#f43f5e' },  // Rose
            { border: '#8b5cf6', bg: '#8b5cf6' }   // Violet
        ];

        const MAX_SELECTORS = 5;
        let chart;
        let selectorCounter = 0;
        let activeSelectors = [];
        const ctx = document.getElementById('superlikeChart').getContext('2d');
        const dates = Object.keys(csvData).sort().reverse();

        // 获取当前时间信息
        function getCurrentTimeInfo() {
            const now = new Date();
            const dateStr = now.toISOString().split('T')[0];
            const timeStr = now.toTimeString().substring(0, 5);
            return { dateStr, timeStr };
        }

        // 处理数据：插值已过期缺失值，忽略未来数据
        function processData(date) {
            const record = csvData[date] || {};
            const { dateStr, timeStr } = getCurrentTimeInfo();
            const isToday = (date === dateStr);

            // 将对象转换为数组映射
            const data = TIME_POINTS.map(t => record[t] ?? null);

            if (isToday) {
                for (let i = 0; i < data.length; i++) {
                    if (TIME_POINTS[i] > timeStr) {
                        data[i] = undefined;
                    }
                }
            }

            for (let i = 0; i < data.length; i++) {
                if (data[i] === null) {
                    let prev = i - 1;
                    let next = i + 1;

                    while (prev >= 0 && (data[prev] === null || data[prev] === undefined)) prev--;
                    while (next < data.length && (data[next] === null || data[next] === undefined)) next++;

                    if (prev !== -1 && next < data.length && data[next] !== undefined) {
                        const startVal = data[prev];
                        const endVal = data[next];
                        data[i] = Math.round(startVal + (endVal - startVal) * ((i - prev) / (next - prev)));
                    } else if (prev !== -1 && (next === data.length || data[next] === undefined)) {
                        data[i] = undefined;
                    }
                }
            }
            return data;
        }

        // 创建日期选择器
        function createDateSelector(colorIndex, defaultDateIndex) {
            const id = selectorCounter++;
            const color = COLORS[colorIndex % COLORS.length];

            const container = document.createElement('div');
            container.className = 'flex items-center gap-2 bg-slate-50 rounded-lg p-2 pr-3';
            container.id = `selector-${id}`;

            const colorDot = document.createElement('span');
            colorDot.className = 'w-3 h-3 rounded-full flex-shrink-0';
            colorDot.style.backgroundColor = color.border;

            const select = document.createElement('select');
            select.className = 'bg-white border border-slate-300 text-slate-700 text-sm rounded-lg p-1.5';
            select.id = `dateSelect-${id}`;

            dates.forEach((date, i) => {
                const option = new Option(date, date);
                select.add(option);
            });
            select.selectedIndex = defaultDateIndex;

            select.addEventListener('change', updateChart);

            container.appendChild(colorDot);
            container.appendChild(select);

            // 添加删除按钮（如果不是最后一个）
            if (activeSelectors.length > 0 || colorIndex > 0) {
                const removeBtn = document.createElement('button');
                removeBtn.className = 'ml-1 text-slate-400 hover:text-red-500 transition-colors';
                removeBtn.innerHTML = '×';
                removeBtn.style.fontSize = '20px';
                removeBtn.style.lineHeight = '1';
                removeBtn.onclick = () => removeSelector(id);
                container.appendChild(removeBtn);
            }

            activeSelectors.push({ id, selectId: `dateSelect-${id}`, colorIndex });
            return container;
        }

        // 添加选择器
        function addSelector() {
            if (activeSelectors.length >= MAX_SELECTORS) {
                alert(`最多支持 ${MAX_SELECTORS} 天对比`);
                return;
            }

            const container = document.getElementById('selectorsContainer');
            const colorIndex = activeSelectors.length;
            const defaultDateIndex = Math.min(activeSelectors.length, dates.length - 1);

            const selector = createDateSelector(colorIndex, defaultDateIndex);
            container.appendChild(selector);

            updateAddButtonState();
            updateChart();
        }

        // 删除选择器
        function removeSelector(id) {
            if (activeSelectors.length <= 1) {
                alert('至少保留一个对比日期');
                return;
            }

            const index = activeSelectors.findIndex(s => s.id === id);
            if (index !== -1) {
                activeSelectors.splice(index, 1);
                document.getElementById(`selector-${id}`).remove();
                updateAddButtonState();
                updateChart();
            }
        }

        // 更新添加按钮状态
        function updateAddButtonState() {
            const btn = document.getElementById('addSelectorBtn');
            if (activeSelectors.length >= MAX_SELECTORS) {
                btn.disabled = true;
                btn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        // 更新图表
        function updateChart() {
            const datasets = activeSelectors.map(selector => {
                const date = document.getElementById(selector.selectId).value;
                const color = COLORS[selector.colorIndex % COLORS.length];
                const data = processData(date);

                return {
                    label: date,
                    data: data,
                    borderColor: color.border,
                    backgroundColor: 'transparent',
                    borderWidth: 3,
                    tension: 0.4,
                    pointRadius: 2,
                };
            });

            if (chart) chart.destroy();

            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: TIME_POINTS,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    const date = context.dataset.label;
                                    const val = context.parsed.y;
                                    const isEstimated = csvData[date][TIME_POINTS[context.dataIndex]] === undefined;
                                    return `${date}: ${val}${isEstimated ? ' (估算)' : ''}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: { color: '#f1f5f9' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: {
                                callback: function (val, index) {
                                    return TIME_POINTS[index].endsWith(':00') ? TIME_POINTS[index] : null;
                                }
                            }
                        }
                    }
                }
            });
        }

        // 初始化
        document.getElementById('addSelectorBtn').addEventListener('click', addSelector);

        // 添加初始的选择器
        const container = document.getElementById('selectorsContainer');
        container.appendChild(createDateSelector(0, 0));
        if (dates.length >= 2) {
            container.appendChild(createDateSelector(1, 1));
        }

        updateAddButtonState();
        updateChart();
    </script>
</body>

</html>