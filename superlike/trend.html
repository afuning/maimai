<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Superlike 数据趋势对比</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .chart-container {
            position: relative;
            margin: auto;
            height: 65vh;
            width: 100%;
        }
    </style>
</head>

<body class="bg-slate-50 p-4 md:p-8">
    <div class="max-w-6xl mx-auto bg-white rounded-2xl shadow-xl p-6 border border-slate-100">
        <div class="flex flex-col md:flex-row md:items-center justify-between mb-8 gap-4 border-b pb-6">
            <div>
                <h1 class="text-2xl font-bold text-slate-800">Superlike 趋势对比分析</h1>
                <p class="text-slate-500 mt-1">支持多日重叠对比。未来时间点不进行数据补全。</p>
            </div>
            <div class="flex flex-wrap gap-3 items-center">
                <div id="selectorsContainer" class="flex flex-wrap gap-3"></div>
                <button id="addSelectorBtn"
                    class="px-3 py-2 bg-indigo-500 hover:bg-indigo-600 text-white text-sm rounded-lg transition-colors flex items-center gap-1">
                    <span class="text-lg leading-none">+</span>
                    <span>添加对比</span>
                </button>
            </div>
        </div>

        <div class="chart-container">
            <canvas id="superlikeChart"></canvas>
        </div>

        <div class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-slate-600">
            <div class="flex items-center gap-2">
                <div class="px-2 py-1 bg-slate-100 rounded italic">注：</div>
                <span>实线点为原始数据或历史插值，曲线截止至当前实际时间。</span>
            </div>
        </div>
    </div>

    <script>
        // 模拟数据 (包含日期和 20 分钟间隔的时间点)
        const csvData = {
            "timePoints": [
                "08:40", "09:00", "09:20", "09:40", "10:00", "10:20", "10:40",
                "11:00", "11:20", "11:40", "12:00", "12:20", "12:40",
                "13:00", "13:20", "13:40", "14:00", "14:20", "14:40",
                "15:00", "15:20", "15:40", "16:00", "16:20", "16:40",
                "17:00", "17:20", "17:40", "18:00", "18:20", "18:40",
                "19:00", "19:20", "19:40", "20:00", "20:20", "20:40",
                "21:00", "21:20", "21:40", "22:00", "22:20", "22:40",
                "23:00", "23:20", "23:40", "00:00"
            ],
            "records": {
                "2026-02-05": [
                    2590, 2632, 2682, 2717, 2770, 2797, 2832, 2885, 2910, 2949,
                    2977, 3009, 3096, null, null, 3165, 3181, 3194, 3204, 3213,
                    3219, 3241, 3254, 3261, 3270, 3282, 3297, 3312, 3334, 3348,
                    null, 3402, 3428, 3454, 3475, 3504, 3535, 3567, 3578, 3618,
                    3658, 3684, 3714, 3742, 3779, 3800, 3841
                ],
                "2026-02-06": [
                    2653, 2706, 2742, 2761, 2793, 2827, 2857,
                    2902, 2924, 3045, 3089, 3109, 3160,
                    3177, 3220, 3249, 3271, 3289, 3303,
                    3317, 3337, 3350, 3368, 3375, 3393,
                    3410, 3426, 3438, 3457, 3472, 3489,
                    3503, 3514, null, 3554, 3563, 3597,
                    3617, 3644, 3681, 3708, 3757, 3794,
                    3810, 3843, 3877, 3919
                ],
                "2026-02-07": [
                    null, null, null, null, null, null, null,
                    null, null, null, null, null, null,
                    null, null, null, null, null, null,
                    null, null, null, null, null, 3471,
                    3515, 3523, 3536, 3551, null, null,
                    null, null, null, null, null, null,
                    3755, 3786, 3810, 3835, 3873, 3925,
                    3937, null, null, 4019
                ]
            }
        };

        // 颜色配置
        const COLORS = [
            { border: '#4f46e5', bg: '#4f46e5' },  // Indigo
            { border: '#10b981', bg: '#10b981' },  // Emerald
            { border: '#f59e0b', bg: '#f59e0b' },  // Amber
            { border: '#f43f5e', bg: '#f43f5e' },  // Rose
            { border: '#8b5cf6', bg: '#8b5cf6' }   // Violet
        ];

        const MAX_SELECTORS = 5;
        let chart;
        let selectorCounter = 0;
        let activeSelectors = [];
        const ctx = document.getElementById('superlikeChart').getContext('2d');
        const dates = Object.keys(csvData.records).reverse();

        // 获取当前时间信息
        function getCurrentTimeInfo() {
            const now = new Date();
            const dateStr = now.toISOString().split('T')[0];
            const timeStr = now.toTimeString().substring(0, 5);
            return { dateStr, timeStr };
        }

        // 处理数据：插值已过期缺失值，忽略未来数据
        function processData(date, rawArr) {
            const { dateStr, timeStr } = getCurrentTimeInfo();
            const isToday = (date === dateStr);
            const data = [...rawArr];

            if (isToday) {
                for (let i = 0; i < data.length; i++) {
                    if (csvData.timePoints[i] > timeStr) {
                        data[i] = undefined;
                    }
                }
            }

            for (let i = 0; i < data.length; i++) {
                if (data[i] === null) {
                    let prev = i - 1;
                    let next = i + 1;

                    while (prev >= 0 && (data[prev] === null || data[prev] === undefined)) prev--;
                    while (next < data.length && (data[next] === null || data[next] === undefined)) next++;

                    if (prev !== -1 && next < data.length && data[next] !== undefined) {
                        const startVal = data[prev];
                        const endVal = data[next];
                        data[i] = Math.round(startVal + (endVal - startVal) * ((i - prev) / (next - prev)));
                    } else if (prev !== -1 && (next === data.length || data[next] === undefined)) {
                        data[i] = undefined;
                    }
                }
            }
            return data;
        }

        // 创建日期选择器
        function createDateSelector(colorIndex, defaultDateIndex) {
            const id = selectorCounter++;
            const color = COLORS[colorIndex % COLORS.length];

            const container = document.createElement('div');
            container.className = 'flex items-center gap-2 bg-slate-50 rounded-lg p-2 pr-3';
            container.id = `selector-${id}`;

            const colorDot = document.createElement('span');
            colorDot.className = 'w-3 h-3 rounded-full flex-shrink-0';
            colorDot.style.backgroundColor = color.border;

            const select = document.createElement('select');
            select.className = 'bg-white border border-slate-300 text-slate-700 text-sm rounded-lg p-1.5';
            select.id = `dateSelect-${id}`;

            dates.forEach((date, i) => {
                const option = new Option(date, date);
                select.add(option);
            });
            select.selectedIndex = defaultDateIndex;

            select.addEventListener('change', updateChart);

            container.appendChild(colorDot);
            container.appendChild(select);

            // 添加删除按钮（如果不是最后一个）
            if (activeSelectors.length > 0 || colorIndex > 0) {
                const removeBtn = document.createElement('button');
                removeBtn.className = 'ml-1 text-slate-400 hover:text-red-500 transition-colors';
                removeBtn.innerHTML = '×';
                removeBtn.style.fontSize = '20px';
                removeBtn.style.lineHeight = '1';
                removeBtn.onclick = () => removeSelector(id);
                container.appendChild(removeBtn);
            }

            activeSelectors.push({ id, selectId: `dateSelect-${id}`, colorIndex });
            return container;
        }

        // 添加选择器
        function addSelector() {
            if (activeSelectors.length >= MAX_SELECTORS) {
                alert(`最多支持 ${MAX_SELECTORS} 天对比`);
                return;
            }

            const container = document.getElementById('selectorsContainer');
            const colorIndex = activeSelectors.length;
            const defaultDateIndex = Math.min(activeSelectors.length, dates.length - 1);

            const selector = createDateSelector(colorIndex, defaultDateIndex);
            container.appendChild(selector);

            updateAddButtonState();
            updateChart();
        }

        // 删除选择器
        function removeSelector(id) {
            if (activeSelectors.length <= 1) {
                alert('至少保留一个对比日期');
                return;
            }

            const index = activeSelectors.findIndex(s => s.id === id);
            if (index !== -1) {
                activeSelectors.splice(index, 1);
                document.getElementById(`selector-${id}`).remove();
                updateAddButtonState();
                updateChart();
            }
        }

        // 更新添加按钮状态
        function updateAddButtonState() {
            const btn = document.getElementById('addSelectorBtn');
            if (activeSelectors.length >= MAX_SELECTORS) {
                btn.disabled = true;
                btn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        // 更新图表
        function updateChart() {
            const datasets = activeSelectors.map(selector => {
                const date = document.getElementById(selector.selectId).value;
                const color = COLORS[selector.colorIndex % COLORS.length];
                const data = processData(date, csvData.records[date]);

                return {
                    label: date,
                    data: data,
                    borderColor: color.border,
                    backgroundColor: 'transparent',
                    borderWidth: 3,
                    tension: 0.4,
                    pointRadius: 2,
                };
            });

            if (chart) chart.destroy();

            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: csvData.timePoints,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    const date = context.dataset.label;
                                    const val = context.parsed.y;
                                    const isEstimated = csvData.records[date][context.dataIndex] === null;
                                    return `${date}: ${val}${isEstimated ? ' (估算)' : ''}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: { color: '#f1f5f9' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: {
                                callback: function (val, index) {
                                    return csvData.timePoints[index].endsWith(':00') ? csvData.timePoints[index] : null;
                                }
                            }
                        }
                    }
                }
            });
        }

        // 初始化
        document.getElementById('addSelectorBtn').addEventListener('click', addSelector);

        // 添加初始的两个选择器
        const container = document.getElementById('selectorsContainer');
        container.appendChild(createDateSelector(0, 0));
        if (dates.length >= 2) {
            container.appendChild(createDateSelector(1, 1));
        }

        updateAddButtonState();
        updateChart();
    </script>
</body>

</html>